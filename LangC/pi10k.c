/**********************************************************************
 *	
 **********************************************************************
 *
 * π＝ 16arctan(1/5)-4arctan(1/239)
 * 
 *           ∞     (-1)**n
 * arctan(x)=Σ  ------------ x**(2n+1) = x - (1/3)x**3 + (1/5)x**5 - (1/7)x**7 ・・・
 *          n=0   2n + 1
 */
#include <stdio.h>
#include <string.h>
#include <malloc.h>

// 2進固定小数（整数部1byte、小数部 PRECISION-1 byte）
#define PRECISION 5000

typedef unsigned char uchar;
//
// 2 進表現の固定小数
// 小数点は1byte目の後ろなので、0.0～255.999999... まで
typedef struct {
	uchar n[PRECISION];
} MP;

MP  *ma,*mb,*mc,*Pi;

void print_pi(MP *p);

/**********************************************************************
 *  整数 n を MP構造体 にセットする.	
 **********************************************************************
 */
MP  *mp_setNum(MP *r,int n)
{
	memset(r,0,sizeof(MP));
	r->n[0]=n;
	return r;
}

/**********************************************************************
 *  mp を 整数 n で除算する
 **********************************************************************
 */
MP  *mp_div(MP *mp,int n)
{
	int i,c,r=0;
	for(i=0;i<PRECISION;i++) {
		c = mp->n[i] + (r<<8);
		mp->n[i] = c / n;
		r = c % n;
	}
	return mp;
}

/**********************************************************************
 *  mp の nバイト目まで0なら 0 を返す.
 **********************************************************************
 */
int mp_zerochk(MP *mp,int n)
{
	int i,c;
	for(i=0;i<n;i++) {
		c = mp->n[i];
		if(c != 0) return 1;
	}
	return 0;
}

/**********************************************************************
 *	多倍長加算： m0 = m1 + m2
 **********************************************************************
 */
MP  *mp_add(MP *m0,MP *m1,MP *m2)
{
	int i,c,r=0;
	for(i=PRECISION-1;i>=0;i--) {
		c = m1->n[i] + m2->n[i] + r;
		m0->n[i] = c;
		if(c>=0x100) r=1;else r=0;
	}
	return m0;
}

/**********************************************************************
 *	多倍長減算： m0 = m1 + m2
 **********************************************************************
 */
MP  *mp_sub(MP *m0,MP *m1,MP *m2)
{
	int i,c,r=0;
	for(i=PRECISION-1;i>=0;i--) {
		c = m1->n[i] - m2->n[i] - r;
		m0->n[i] = c;
		if(c<0) r=1;else r=0;
	}
	return m0;
}

/**********************************************************************
 *  m0 を 10倍する.
 **********************************************************************
 */
MP  *mp_mul10(MP *m0)
{
	int i,c,r=0;
	for(i=PRECISION-1;i>=0;i--) {
		c = m0->n[i];
		c = c * 10 + r;
		m0->n[i] = c;
		r = (c >> 8) & 0xff;
	}
	return m0;
}

/**********************************************************************
 *	mp (2進表現の固定小数バッファ) をmalloc()で確保し、整数値 (num) をセット.
 **********************************************************************
 */
MP  *mp_new(int num)
{
	MP *r = (MP *)malloc(sizeof(MP));
	mp_setNum(r,num);
	return r;
}

/**********************************************************************
 *	mp を m バイト分、16進ダンプ
 **********************************************************************
 */
void dump_mp(MP *p,int m)
{
	int i;
	for(i=0;i<m;i++) {
		printf("%02x ",p->n[i]);
	}
	printf("\n");
}

/**********************************************************************
 *	mp を小数以下 (PRECISION*2+1) まで印字.
 **********************************************************************
 */
void print_pi(MP *p)
{
	int i,c,tab=0,lf=0;

	for(i=0;i< (PRECISION*2+1) ;i++) {
		c=p->n[0];
		  p->n[0] = 0;
		mp_mul10(p);
		if(i==0) {
			printf("PI = %c. + \n",'0'+c);
		}else{
			printf("%c",'0'+c);
			tab++;if(tab>=10) {tab=0;
				printf(" ");
				lf++;if(lf>=5) {lf=0;
					printf("\n");
				}
			}
		}
	}
	printf("\n");
}

/**********************************************************************
 *  ひとつのArcTan項を計算する ma = m * atan(1/n)
 **********************************************************************
 */
void calc_M_atan_1_N(int m,int n)
{
	int i;
	int s=1;

// ma = m * (1/n)
	mp_setNum(ma,m);
	mp_div(ma,n);
// mc = m * (1/n)
    *mc = *ma;

	
// arctan(x) = x - (1/3)x**3 + (1/5)x**5 - (1/7)x**7 ・・・
// LOOP: ma +-= mb

	for(i=3;i<65536;i+=2) {
		// mc = mc*(1/n)*(1/n)
		mp_div(mc,n);
		mp_div(mc,n);
		
		// mb = mc*(1/i)
		*mb = *mc;
		mp_div(mb,i);
		
		if(mp_zerochk(mb,PRECISION-16)==0) break;
		
		s=s*(-1);
		if(s<0) {
			mp_sub(ma,ma,mb);
		}else{
			mp_add(ma,ma,mb);
		}
	}
//	dump_mp(mb,PRECISION);
}

/**********************************************************************
 *	マチンの公式でπを計算して、Pi に格納
 **********************************************************************
 */
void calc_pi()
{
//	16 arctan(1/5)
	calc_M_atan_1_N(16,  5);
	*Pi = *ma;

// -4 arctan(1/239)
	calc_M_atan_1_N( 4,239);
	mp_sub(Pi,Pi,ma);

// ===> Pi
}

/**********************************************************************
 *	メインルーチン.
 **********************************************************************
 */
int	main(int argc,char **argv)
{
	ma = mp_new(0);
	mb = mp_new(0);
	mc = mp_new(0);
	Pi = mp_new(0);

	calc_pi();
	print_pi(Pi);

	return 0;
}
/**********************************************************************
 *
 **********************************************************************
 */
